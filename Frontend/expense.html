<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Document</title>
   </head>
   <body>
      <form onsubmit="addExpense(event)">
         <label for="amount">Enter Amount</label>
         <input type="number" id="amount" name="amount" required />
         <label for="desc">Description</label>
         <input type="text" id="desc" name="desc" required />
         <label for="cat">Category</label>
         <select id="cat">
            <option>Choose Category</option>
            <option>Food</option>
            <option>Shopping</option>
            <option>petrol</option>
            <option>Bills</option>
            <option>Rent</option>
            <option>Travel</option>
         </select>
         <button type="submit">Add Expense</button><br />
      </form>

      <div>
         <button id="rzp-button1">Buy Premium</button>
      </div>

      <div>
         <ul style="list-style-type: circle" id="items"></ul>
      </div>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.1/axios.min.js"></script>

      <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

      <script>
         var items = document.getElementById("items");

         function display(obj) {
            var tit = `${obj.amount} ${obj.description} ${obj.category}`;
            let ul = `<li id="${obj.id}" ">
                ${tit}
                <button type="submit" onclick="delFun('${obj.id}')">
                        Delete
                </button>
                </li>`;

            items.innerHTML += ul;
         }
         const token = localStorage.getItem("token");

         window.addEventListener("DOMContentLoaded", () => {
            axios
               .get(`http://localhost:3000/pastentries`, {
                  headers: { Authorization: token },
               })
               .then((res) => {
                  console.log("GET Full response:");
                  const Data = res.data;
                  console.log(Data);
                  Data.forEach((obj) => {
                     display(obj);
                  });
               })
               .catch((err) => {
                  console.log("GET error:", err);
               });
         });

         async function addExpense(e) {
            e.preventDefault();
            const amount = document.getElementById("amount").value;
            const description = document.getElementById("desc").value;
            const category = document.getElementById("cat").value;
            const obj = {
               amount,
               description,
               category,
            };
            console.log("obj ", obj);
            try {
               await axios
                  .post("http://localhost:3000/addexpense", obj, {
                     headers: { Authorization: token },
                  })
                  .then((res) => {
                     console.log("post res:");
                     console.log(res.data);
                     display(res.data);
                     document.getElementById("amount").value = "";
                     document.getElementById("desc").value = "";
                     document.getElementById("cat").value = "Choose Category";
                  });
            } catch (error) {
               console.log("Post Error: " + error);
            }
         }

         function delFun(id) {
            console.log("DELETE BTN:");
            axios
               .delete(`http://localhost:3000/deletexpense/${id}`, {
                  headers: { Authorization: token },
               })
               .then((res) => {
                  console.log(res);
                  let x = document.getElementById(id);
                  items.removeChild(x);
               })
               .catch((err) => {
                  console.log(err);
               });
         }

         document.getElementById("rzp-button1").onclick = async function (e) {
            const response = await axios.get(
               "http://localhost:3000/purchase/premium",
               {
                  headers: { Authorization: token },
               }
            );
            console.log("res:")
            console.log(response);
            var options = {
               key: response.data.key_id,
               order_id: response.data.order.id,
               handler: async function (response) {
                  const res = await axios.post(
                     "http://localhost:3000/purchase/updatetransactionstatus",
                     {
                        order_id: options.order_id,
                        payment_id: response.razorpay_payment_id,
                     },
                     { headers: { Authorization: token } }
                  );

                  alert("You are a premium user");
                  // showPremiumMessage();
                  // localStorage.setItem("token", res.data.token);
                  // showLeaderboard();
               },
            };
            const rzp1 = new Razorpay(options);
            rzp1.open();
            e.preventDefault();

            rzp1.on("payment.failed", async function (response) {
               console.log(response);

               // const resp = await axios.post(
               //    "http://localhost:3000/purchase/updatetransactionfail",
               //    {
               //       order_id: options.order_id,
               //    },
               //    { headers: { Authorization: token } }
               // );

               // console.log(resp);
               alert("something went wrong");
            });
         };
      </script>
   </body>
</html>
